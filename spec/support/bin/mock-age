#!/bin/sh

set -Cue

die() {
	printf '%s\n' "$*" >&2
	exit 1
}

case "$1" in
    -e)
	shift
	MOCK_AGE_OUTPUT="$(@mktemp "$(dirname "$2")/mock-age-encrypt.XXXXXXX")"
	while [ $# -gt 0 ]; do
		case "$1" in
			-R|-i)
			@sed 's/^/ageRecipient:/' "$2" >>"${MOCK_AGE_OUTPUT}"
			shift 2 ;;
			-r)
			printf 'ageRecipient:%s\n' "$2" >>"${MOCK_AGE_OUTPUT}"
			shift 2 ;;
			-o)
			[ $# -eq 2 ] || die 'Unexpected age -e [...] %s\n' "$*"
			@sed 's/^/age:/' >>"${MOCK_AGE_OUTPUT}"
			@mv -f "${MOCK_AGE_OUTPUT}" "$2"
			shift 2 ;;
			*)
			die 'Unexpected age -e [...] %s\n' "$*"
			;;
		esac
	done
	;;
    -d)
	[ "$2" = '-i' ] || die "Unexpected age -d \$2: \"$2\""
	[ "$4" = '--' ] || die "Unexpected age -d \$4: \"$4\""
	@grep -v '^age' "$5" >&2 && die "Bad encrypted file \"$4\""
	if ! @grep -qFx "ageRecipient:$(@cat "$3")" "$5"; then
		die "Bad identity \"$3\": $(@cat "$3")"
		exit 1
	fi
	@sed -n 's/^age://p' "$5"
	;;
    *)
	die "Unexpected age \$1: \"$1\""
	;;
esac
